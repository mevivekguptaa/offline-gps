<!DOCTYPE html>
<html>
<head>
  <title>Offline GPS App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">

  <!-- Leaflet Map (loads once, cached later) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial; padding: 12px; }
    #map { height: 300px; margin-top: 10px; }
    button { margin-top: 10px; padding: 8px; }
  </style>
</head>

<body>

<h3>üìç Offline GPS App</h3>

<p id="status">Waiting for GPS‚Ä¶</p>

<button onclick="showHistory()">üìú Show Location History</button>
<div id="history"></div>

<div id="map"></div>

<script>
let map, marker;

/* WATCH GPS (LIVE UPDATES, NO INTERNET) */
navigator.geolocation.watchPosition(
  function(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    const speed = pos.coords.speed;

    document.getElementById("status").innerHTML =
      `Latitude: ${lat}<br>
       Longitude: ${lon}<br>
       Accuracy: ${acc} meters<br>
       Speed: ${speed ? (speed * 3.6).toFixed(1) + " km/h" : "0 km/h"}`;

    if (!map) {
      map = L.map("map").setView([lat, lon], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);
      marker = L.marker([lat, lon]).addTo(map);
    } else {
      marker.setLatLng([lat, lon]);
      map.setView([lat, lon]);
    }

    saveLocation(lat, lon);
  },
  function(err) {
    document.getElementById("status").innerHTML =
      "GPS Error: " + err.message;
  },
  { enableHighAccuracy: true }
);

/* SAVE LOCATION LOCALLY (OFFLINE STORAGE) */
function saveLocation(lat, lon) {
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  history.push({
    lat: lat,
    lon: lon,
    time: new Date().toLocaleString()
  });
  localStorage.setItem("history", JSON.stringify(history));
}

/* SHOW LAST 10 LOCATIONS */
function showHistory() {
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  let html = "<ul>";
  history.slice(-10).reverse().forEach(h => {
    html += `<li>${h.time}<br>${h.lat}, ${h.lon}</li>`;
  });
  html += "</ul>";
  document.getElementById("history").innerHTML = html;
}
</script>

<!-- REGISTER SERVICE WORKER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
