<!DOCTYPE html>
<html>
<head>
  <title>Offline GPS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial; padding: 10px; }
    #map { height: 320px; margin-top: 10px; }
    button { padding: 8px; margin: 6px 0; }
  </style>
</head>

<body>

<h3>üìç Offline GPS Tracker</h3>

<p id="status">Waiting for GPS‚Ä¶</p>

<button onclick="showToday()">üìÖ Show Today‚Äôs Places</button>
<div id="summary"></div>

<div id="map"></div>

<script>
/* ---------------- DATE KEY ---------------- */
let todayKey = new Date().toISOString().split("T")[0];

/* ---------------- ROUTE STORAGE ---------------- */
let routePoints =
  JSON.parse(localStorage.getItem("route_" + todayKey)) || [];

/* ---------------- MAP OBJECTS ---------------- */
let map, marker, routeLine;

/* ---------------- STAY TRACK ---------------- */
let lastStay = null;

/* ---------------- GPS WATCH ---------------- */
navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    const speed = pos.coords.speed || 0;
    const now = new Date();

    document.getElementById("status").innerHTML =
      `Latitude: ${lat}<br>
       Longitude: ${lon}<br>
       Accuracy: ${acc.toFixed(1)} m<br>
       Speed: ${(speed * 3.6).toFixed(1)} km/h`;

    /* ---- SAVE ROUTE POINT ---- */
    routePoints.push([lat, lon]);
    localStorage.setItem(
      "route_" + todayKey,
      JSON.stringify(routePoints)
    );

    /* ---- MAP INIT OR UPDATE ---- */
    if (!map) {
      map = L.map("map").setView([lat, lon], 17);
      L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom: 19 }
      ).addTo(map);

      marker = L.marker([lat, lon]).addTo(map);
      routeLine = L.polyline(routePoints, {
        color: "blue",
        weight: 4
      }).addTo(map);
    } else {
      marker.setLatLng([lat, lon]);
      routeLine.setLatLngs(routePoints);
      map.panTo([lat, lon]);
    }

    handleStay(lat, lon, now);
  },
  err => alert(err.message),
  { enableHighAccuracy: true }
);

/* ---------------- STAY DETECTION ---------------- */
function handleStay(lat, lon, time) {
  if (!lastStay) {
    lastStay = { lat, lon, start: time, fetched: false };
    return;
  }

  const d = distance(
    lastStay.lat,
    lastStay.lon,
    lat,
    lon
  );

  if (d < 50) {
    const mins = (time - lastStay.start) / 60000;

    if (mins >= 30 && !lastStay.fetched) {
      fetchPlaceName(lastStay.lat, lastStay.lon, place => {
        saveStay(
          lastStay.start,
          time,
          lastStay.lat,
          lastStay.lon,
          place
        );
        lastStay.fetched = true;
      });
    }
  } else {
    lastStay = { lat, lon, start: time, fetched: false };
  }
}

/* ---------------- SAVE STAY ---------------- */
function saveStay(start, end, lat, lon, place) {
  let data = JSON.parse(localStorage.getItem("stays") || "{}");
  if (!data[todayKey]) data[todayKey] = [];

  data[todayKey].push({
    from: start.toISOString(),
    to: end.toISOString(),
    lat,
    lon,
    place
  });

  localStorage.setItem("stays", JSON.stringify(data));
}

/* ---------------- SHOW DAY SUMMARY ---------------- */
function showToday() {
  let data = JSON.parse(localStorage.getItem("stays") || "{}");
  let list = data[todayKey] || [];

  if (list.length === 0) {
    document.getElementById("summary").innerHTML =
      "No places recorded yet.";
    return;
  }

  let html = "<h4>üìç Places Visited Today</h4><ul>";
  list.forEach(s => {
    html += `<li>
      ${new Date(s.from).toLocaleTimeString()} ‚Äì
      ${new Date(s.to).toLocaleTimeString()}<br>
      ${s.place}
    </li>`;
  });
  html += "</ul>";

  document.getElementById("summary").innerHTML = html;
}

/* ---------------- DISTANCE CALC ---------------- */
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(ŒîœÜ / 2) ** 2 +
    Math.cos(œÜ1) * Math.cos(œÜ2) *
    Math.sin(ŒîŒª / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ---------------- PLACE NAME (FREE) ---------------- */
async function fetchPlaceName(lat, lon, cb) {
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
      { headers: { "User-Agent": "OfflineGPSApp" } }
    );
    const data = await res.json();
    cb(data.display_name || "Unknown place");
  } catch {
    cb("Place name not fetched");
  }
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
