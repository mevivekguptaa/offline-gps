<!DOCTYPE html>
<html>
<head>
  <title>Offline GPS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial; padding: 10px; }
    #map { height: 320px; margin-top: 10px; }
    .warn { color: red; font-weight: bold; }
  </style>
</head>

<body>

<h3>üìç Offline GPS Tracker</h3>

<p id="status">Waiting for GPS‚Ä¶</p>

<div id="map"></div>

<script>
/* ---------------- VISIBILITY WARNING ---------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    document.getElementById("status").innerHTML =
      "‚ö† App paused. Keep this app OPEN for GPS tracking.";
  }
});

/* ---------------- DATE KEY ---------------- */
let todayKey = new Date().toISOString().split("T")[0];

/* ---------------- ROUTE STORAGE ---------------- */
let routePoints =
  JSON.parse(localStorage.getItem("route_" + todayKey)) || [];

/* ---------------- MAP OBJECTS ---------------- */
let map, marker, routeLine;
let watchId = null;

/* ---------------- START GPS ---------------- */
function startTracking() {
  if (watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      const speed = pos.coords.speed || 0;

      document.getElementById("status").innerHTML =
        `Latitude: ${lat}<br>
         Longitude: ${lon}<br>
         Accuracy: ${acc.toFixed(1)} m<br>
         Speed: ${(speed * 3.6).toFixed(1)} km/h`;

      routePoints.push([lat, lon]);
      localStorage.setItem(
        "route_" + todayKey,
        JSON.stringify(routePoints)
      );

      if (!map) {
        map = L.map("map").setView([lat, lon], 17);
        L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          { maxZoom: 19 }
        ).addTo(map);

        marker = L.marker([lat, lon]).addTo(map);
        routeLine = L.polyline(routePoints, {
          color: "blue",
          weight: 4
        }).addTo(map);
      } else {
        marker.setLatLng([lat, lon]);
        routeLine.setLatLngs(routePoints);
        map.panTo([lat, lon]);
      }
    },
    err => {
      document.getElementById("status").innerHTML =
        "‚ùå GPS error: " + err.message;
    },
    { enableHighAccuracy: true }
  );
}

/* ---------------- STOP GPS (BACKGROUND) ---------------- */
function stopTracking() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

/* ---------------- HANDLE FOREGROUND / BACKGROUND ---------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopTracking();
  } else {
    startTracking();
  }
});

/* ---------------- START INITIALLY ---------------- */
startTracking();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
